# QR Integration

To put a QR on your login page you'll need to do the following:

1. Install the `keyri-auth-core` library (`npm i keyri-auth-core`)

2. Serve an `iframe`

3. Embed the `iframe` on your login page

4. Set up an `event listener` to handle events being emmitted from this library

## Serving An iFrame

1. Create a file called `qr.html` (or whatever) and serve it from the same origin as your login page (e.g. a `/public` directory)

2. _RECOMMENDED_: serve everything on your page's origin with the header `X-Frame-Options: SAMEORIGIN` (examples [here](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Frame-Options#examples))

3. Include the following in the body of the iframe:

```html
    <div class="pre-blurry" id="qr-target"></div>
    <div id="qr-lay-over"></div>
```
( By the way, the working example of [iframe](https://github.com/Keyri-Co/keyri-hello-world/blob/main/static/qr.html) and [css](https://github.com/Keyri-Co/keyri-hello-world/blob/main/static/css/qr.css) which are probably good enough to get you started)

4. Start the `IFrameManager`

```js
  import { IFrameManager } from 'keyri-auth-core';
  const iFrameManager = new IFrameManager();
  await iFrameManager.start();
```

## Embedding the iFrame

Embed an iframe in your authentication page in the desired DOM element with ./qr.html as its src. 

Any querystring parameters you add to that src are available to your mobile app via our API.

Also, there are a few "special" parameters that do things:

### Special iFrame Parameters

Please note none of these are necessary, but are avaible to use if they help you and your situation.

- _qsd_ - If true, all query-string-data will be put into the QR code itself.

- _mobile_ - If you are allowing "appless" auth, this is the address of your mobile site.

- _Environment_ - If "dev" or "test", puts you on that environment and lets your change your origin.

- _Origin_ - The `origin` your site actually sits on when not on localhost. This only works if you are on localhost, and your `Environment` is "dev". 

### Production Example
```html
<!-- PRODUCTION -->
<iframe
    scrolling="no"
    frameborder="0"
    height="500"
    width="500"
    src="./qr.html?qsd=false&mobile=http://my.site.com/mobile.html"
    id="qr-iframe"
></iframe>
```

### Development Example
```html
<!-- DEVELOPMENT -->
<iframe
    scrolling="no"
    frameborder="0"
    height="500"
    width="500"
    src="./qr.html?qsd=false&Origin=your.site.com&Environment=dev&mobile=http://localhost/mobile.html"
    id="qr-iframe"
></iframe>
```

## QR Event Handling

### Getting Data
So you've got a QR code on your page now? Great! Next, you'll probably want to something with the information coming out of it and your user's phone.

### Event Types
Below are the event types that are currently avaible to listen to from the library:

* _qr_event_mobile_connect_ - this is when a mobile device connects to your QR Code

* _qr_event_socket_error_ - when there's an error coming from the API

* _qr_event_risk_data_ - Risk Data about the connection coming from the API

* _qr_event_session_validate_ - Decrypted data from the mobile app

* _qr_event_appless_login_ - If you're using mobile QR login, this is what will be emmitted when the user is logged in

* _qr_event_appless_registration_ - When the user registers their phone via QR for appless, this is the event that it emmitted

### Setup

```js
// ./src/mjs/eventManager.mjs

import {EventManager} from "keyri-auth-core";
window.eventManager = new EventManager(window);

// Set handler for standard Keyri App Based Validation
window.addEventListener("qr_event_session_validate", async (evt) => {
  console.log("SESSION VALIDATE", evt);
});

// Set handler for whatever risk data comes from the QR
window.addEventListener("qr_event_risk_data", async (evt) => {
  let data = evt.detail.data.information.data;
  console.log("RISK DATA", JSON.parse(atob(data)));
});

// Set handler for any errors coming out of the QR
window.addEventListener("qr_event_socket_error", async (evt) => {
  alert(evt?.detail?.data);
});

export default true;
```
